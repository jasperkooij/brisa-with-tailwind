// @bun
import q from"path";import j from"fs/promises";var S=/(\/?index)?\.html?$/;function D({memory:V,regions:x,maxDuration:B}={}){return{name:"vercel",async adapt({CONFIG:Y,ROOT_DIR:M,BUILD_DIR:P,I18N_CONFIG:G},h){const Q=G?.defaultLocale,b=q.join(M,".vercel"),Z=q.join(b,"output"),R=q.join(Z,"config.json"),_=q.join(M,"out"),C=q.join(P,"public"),U=q.join(Z,"static");switch(Y.output){case"static":{await X(),await E();break}case"node":{await X(),await N();break}default:{console.error('Vercel adapter only supports "node" and "static" output. Please set the "output" field in the brisa.config.ts file');return}}async function X(){await j.rm(b,{recursive:!0,force:!0}),await j.mkdir(b),await j.mkdir(Z)}async function N(){const z=q.join(Z,"functions","fn.func"),W=q.join(z,"package.json"),$=q.join(z,".vc-config.json");if(await E({useFileSystem:!0}),!await j.exists(z))await j.mkdir(z,{recursive:!0});const A={runtime:"nodejs20.x",handler:"build/server.js",launcherType:"Nodejs",experimentalResponseStreaming:!0,environment:{USE_HANDLER:"true"}};if(V)A.memory=V;if(x)A.regions=x;if(B)A.maxDuration=B;await j.writeFile(W,'{"type":"module"}',"utf-8"),await j.writeFile($,JSON.stringify(A,null,2),"utf-8");const k=q.join(z,"build");await j.cp(P,k,{recursive:!0})}async function E({useFileSystem:z=!1}={}){let W="";const $=Array.from(h?.values()??[]).flat(),A=Y.trailingSlash?"/":"",k=Y.trailingSlash?"":"/",w=$.flatMap((H)=>{const K=H.replace(/^\//,"");if(K==="index.html")return Q?[{src:"/",status:308,headers:{Location:`/${Q}`}}]:[{src:"/",dest:"/index.html"}];const J=K.replace(S,""),y=`/${J}${A}`,L=`/${J}${k}`;if(J.endsWith("_404"))W=Q?`/${Q}/_404`:"/_404";return[{src:y,dest:L},{headers:{Location:y},src:L,status:308}]}),T={};for(let H of $){const K=H.replace(/^\//,"");if(K==="index.html"&&Q)continue;T[K]={path:K.replace(S,"")}}if(process.env.VERCEL_SKEW_PROTECTION_ENABLED)w.push({src:"/.*",has:[{type:"header",key:"Sec-Fetch-Dest",value:"document"}],headers:{"Set-Cookie":`__vdpl=${process.env.VERCEL_DEPLOYMENT_ID}; Path=${Y.basePath??""}/; SameSite=Strict; Secure; HttpOnly`},continue:!0});if(z)w.push(...[{handle:"filesystem"},{src:"/.*",dest:"/fn"}]);if(!z&&W)w.push({handle:"filesystem"},{src:"/(.*)",status:404,dest:W});const m={version:3,routes:w,overrides:T};await j.writeFile(R,JSON.stringify(m,null,2)),await j.mkdir(U);const v=z?C:_;if(await j.exists(v))await j.cp(v,U,{recursive:!0})}}}}export{D as default};
